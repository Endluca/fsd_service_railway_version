// Prisma Schema for 51Talk Dashboard

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 销售人员信息表
model SalesPerson {
  id                  Int             @id @default(autoincrement())
  openUserId          String          @unique @map("open_user_id") @db.VarChar(100)
  megName             String          @map("meg_name") @db.VarChar(100)  // 来自销售API的姓名
  mainDepartmentId    Int             @map("main_department_id")        // 主部门ID
  isDelete            Boolean         @default(false) @map("is_delete") // 是否离职
  status              String          @default("正常") @map("status") @db.VarChar(20)  // 状态：正常/用户不存在
  
  // 来自部门API的信息
  departmentName      String          @default("默认值") @map("department_name") @db.VarChar(100)  // 部门名称
  parentDepartmentId  Int             @default(0) @map("parent_department_id")          // 父部门ID
  leadOpenUserId      String          @default("默认值") @map("lead_open_user_id") @db.VarChar(100)  // 部门负责人
  
  // 同步日志
  logInfo             String?         @map("log_info") @db.Text        // 同步错误日志（JSON数组）
  
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")

  // 关系
  dailyMetrics        DailyMetric[]
  cacheRecords        DateRangeCache[]

  // 索引
  @@index([megName])
  @@index([departmentName])
  @@index([status])
  @@index([mainDepartmentId])

  @@map("sales_person")
}

// 每日元数据表
model DailyMetric {
  id                      Int      @id @default(autoincrement())
  date                    DateTime @db.Date
  openUserId              String   @map("open_user_id") @db.VarChar(100)
  customerTurnCount       Int      @default(0) @map("customer_turn_count")
  timelyReplyCount        Int      @default(0) @map("timely_reply_count")
  overtimeReplyCount      Int      @default(0) @map("overtime_reply_count")
  totalReplyDuration      BigInt   @default(0) @map("total_reply_duration") // 单位：秒
  newRuleCustomerTurnCount Int     @default(0) @map("new_rule_customer_turn_count") // 新规则总消息数
  overtimeNoReplyCount    Int      @default(0) @map("overtime_no_reply_count") // 超时未回复数
  processedConversationIds String[] @default([]) @map("processed_conversation_ids")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  salesPerson SalesPerson @relation(fields: [openUserId], references: [openUserId])

  @@unique([date, openUserId])
  @@index([date])
  @@index([openUserId])
  @@map("daily_metrics")
}

// 日期范围缓存表
model DateRangeCache {
  id                       Int      @id @default(autoincrement())
  startDate                DateTime @map("start_date") @db.Date
  endDate                  DateTime @map("end_date") @db.Date
  openUserId               String   @map("open_user_id") @db.VarChar(100)
  customerTurnCount        Int      @map("customer_turn_count")
  timelyReplyRate          Decimal  @map("timely_reply_rate") @db.Decimal(5, 2)
  overtimeReplyRate        Decimal  @map("overtime_reply_rate") @db.Decimal(5, 2)
  avgReplyDuration         Decimal  @map("avg_reply_duration") @db.Decimal(10, 2) // 单位：分钟
  newRuleCustomerTurnCount Int      @default(0) @map("new_rule_customer_turn_count") // 新规则总消息数
  overtimeReplyCount       Int      @default(0) @map("overtime_reply_count") // 超时回复数
  overtimeNoReplyCount     Int      @default(0) @map("overtime_no_reply_count") // 超时未回复数
  conversationCount        Int      @default(0) @map("conversation_count") // 会话数
  createdAt                DateTime @default(now()) @map("created_at")

  salesPerson SalesPerson @relation(fields: [openUserId], references: [openUserId])

  @@unique([startDate, endDate, openUserId])
  @@index([startDate, endDate])
  @@map("date_range_cache")
}

// API令牌管理表
model ApiToken {
  id          Int      @id @default(autoincrement())
  tokenType   String   @default("app_access_token") @map("token_type") @db.VarChar(50)
  accessToken String   @map("access_token") @db.Text
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("api_tokens")
}

// TopicMining: 报告表
model Report {
  id             String   @id @default(uuid())
  title          String   @db.VarChar(255)
  summary        String?  @db.Text
  statisticsJson Json     @map("statistics_json")
  samplesJson    Json     @map("samples_json")
  metadataJson   Json?    @map("metadata_json")
  generatedAt    DateTime @map("generated_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@index([createdAt(sort: Desc)])
  @@map("reports")
}

// 红线记录表
model RedLineRecord {
  id                 Int      @id @default(autoincrement())
  conversationId     String   @map("conversation_id") @db.VarChar(200)
  customer           String   @db.VarChar(200)
  sales              String   @db.VarChar(200)
  department         String   @db.VarChar(20) // cc/ss/lp
  originalDepartment String   @map("original_department") @db.VarChar(200)
  redLineType        String   @map("red_line_type") @db.VarChar(200)
  content            String   @db.Text
  weekStart          DateTime @map("week_start") @db.Date
  weekEnd            DateTime @map("week_end") @db.Date
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@unique([weekStart, weekEnd, conversationId, redLineType])
  @@index([weekStart, weekEnd])
  @@index([department])
  @@index([sales])
  @@index([conversationId])
  @@map("red_line_record")
}

// 愤怒小鸟记录表
model AngryBirdRecord {
  id                   Int      @id @default(autoincrement())
  conversationId       String   @map("conversation_id") @db.VarChar(200)
  conversationStartTime DateTime @map("conversation_start_time") @db.Timestamp
  customer             String   @db.VarChar(200)
  sales                String   @db.VarChar(200)
  department           String   @db.VarChar(20) // cc/ss/lp
  originalDepartment   String   @map("original_department") @db.VarChar(200)
  customerEmotion      String   @map("customer_emotion") @db.VarChar(200)
  content              String?  @db.Text // 原文可选，允许为空
  weekStart            DateTime @map("week_start") @db.Date
  weekEnd              DateTime @map("week_end") @db.Date
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@unique([weekStart, weekEnd, conversationId])
  @@index([weekStart, weekEnd])
  @@index([department])
  @@index([sales])
  @@index([customerEmotion])
  @@index([conversationId])
  @@map("angry_bird_record")
}

// 周会话总数表 (用于红线对比功能)
model WeekConversationCount {
  id                Int      @id @default(autoincrement())
  weekStart         DateTime @map("week_start") @db.Date
  weekEnd           DateTime @map("week_end") @db.Date
  department        String   @db.VarChar(20) // cc/ss/lp
  conversationCount Int      @map("conversation_count")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@unique([weekStart, weekEnd, department])
  @@index([weekStart, weekEnd])
  @@index([department])
  @@map("week_conversation_count")
}
